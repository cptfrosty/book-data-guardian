# Хранимые функции в PostgreSQL

**Тип занятия:** лекция

**Продолжительность:** 2 академических часа

## 1. Что такое хранимая функция

**Хранимая функция (Stored Function)** — это программный объект базы данных, который:

- хранится в БД
- принимает параметры
- выполняет SQL-операции
- возвращает значение

> Функция — это способ перенести часть бизнес-логики внутрь СУБД.

Хранимые функции применяются для:

- инкапсуляции бизнес-логики
- повторного использования кода
- обеспечения целостности данных
- ограничения доступа к таблицам
- повышения безопасности

## 2. Общий синтаксис

В PostgreSQL функции создаются через `CREATE FUNCTION`.

```sql
CREATE FUNCTION function_name(parameter_list)
RETURNS return_type
LANGUAGE plpgsql
AS $$
BEGIN
    -- тело функции
END;
$$;
```

## 3. Простая функция

Пример: функция, возвращающая среднюю зарплату.

```sql
CREATE FUNCTION avg_salary()
RETURNS NUMERIC
LANGUAGE SQL
AS $$
    SELECT AVG(salary) FROM employees;
$$;
```

Вызов функции:

```sql
SELECT avg_salary();
```

> Это SQL-функция без процедурной логики.

## 4. Функция с параметрами

```sql
CREATE FUNCTION get_client_total(client_id INT)
RETURNS NUMERIC
LANGUAGE SQL
AS $$
    SELECT SUM(oi.quantity * oi.price)
    FROM orders o
    JOIN order_items oi ON oi.order_id = o.id
    WHERE o.client_id = get_client_total.client_id;
$$;
```

Вызов: 

```sql
SELECT get_client_total(5);
```

## 5. PL/pgSQL — процедурный язык

PostgreSQL поддерживает процедурный язык plpgsql.

Позволяет использовать:

- переменные
- условия (IF)
- циклы (LOOP)
- обработку ошибок

## 6. Пример функции на PL/pgSQL

```sql
CREATE FUNCTION increase_salary(emp_id INT, percent NUMERIC)
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE employees
    SET salary = salary * (1 + percent / 100)
    WHERE id = emp_id;
END;
$$;
```

```sql
SELECT increase_salary(3, 10);
```

## 7. Переменные

В PL/pgSQL можно объявлять переменные:

```sql
DECLARE
    total NUMERIC;
BEGIN
    SELECT SUM(salary) INTO total
    FROM employees;

    RETURN total;
END;
```

## 8. Условные конструкции

```sql
IF total > 100000 THEN
    RETURN 'VIP';
ELSE
    RETURN 'Standard';
END IF;
```

## 9. Возврат нескольких строк

```sql
CREATE FUNCTION get_high_salary_employees(min_salary NUMERIC)
RETURNS TABLE(id INT, full_name TEXT, salary NUMERIC)
LANGUAGE SQL
AS $$
    SELECT id, full_name, salary
    FROM employees
    WHERE salary > min_salary;
$$;
```

Использование:

```sql
SELECT * FROM get_high_salary_employees(70000);
```

## 10. Разница между FUNCTION и PROCEDURE

|FUNCTION               | PROCEDURE             |
|-----------------------|-----------------------|
|Возвращает значение    | Может не возвращать   |
|Вызывается через SELECT| Вызывается через CALL |
|Используется в запросах| Нет                   |

> В PostgreSQL процедуры появились с версии 11.

## 11. Права доступа и безопасность

Можно дать доступ только к функции:

```sql
GRANT EXECUTE ON FUNCTION get_client_total(INT) TO analyst;
```

> Пользователь может выполнять функцию, не имея доступа к таблицам.

## 12. Производительность

Функции:

- уменьшают сетевой трафик
- выполняются на сервере
- могут кэшироваться

Но:

- чрезмерная логика внутри БД усложняет поддержку
- сложные функции могут ухудшать план выполнения

## 14. Типичные ошибки

|Ошибка                         |	Причина                 |
|-------------------------------|---------------------------|
|Забытый RETURN                 |	Синтаксическая ошибка   |
|Несоответствие типа возврата   |	Ошибка выполнения       |
|SELECT без INTO                |	Ошибка в PL/pgSQL       |
|Логика, дублирующая приложение |	Архитектурная ошибка    |

## 15. Когда использовать хранимые функции

Использовать, если:

- логика должна быть централизована
- необходимо обеспечить безопасность
- требуется атомарность операций
- нужна повторяемость расчётов

Не использовать, если:

- логика специфична для одного клиента
- код постоянно меняется
- требуется высокая масштабируемость приложения

## 16. Выводы

Хранимые функции:

- переносят бизнес-логику в БД
- обеспечивают повторное использование кода
- повышают безопасность
- могут возвращать скалярные значения или таблицы
- являются основой для триггеров

## Домашнее задание

Таблицы:

- clients
- orders
- order_items
- employees

### Задание 1

Создать функцию `get_avg_salary()`

Которая:

- возвращает среднюю зарплату сотрудников
- не принимает параметров

> Тип возврата — NUMERIC.

### Задание 2.

Создать функцию `get_client_total(p_client_id INT)`

Которая:

- возвращает общую сумму заказов клиента
- если заказов нет — возвращает 0

> Обработать возможный NULL.

### Задание 3

Создать функцию `get_client_status(p_client_id INT)`

Которая:

- если сумма заказов > 100 000 → возвращает 'VIP'
- если сумма > 50 000 → 'Regular'
- иначе → 'New'

> Использовать: переменную и IF / ELSIF

Задание 4. Функция, возвращающая таблицу

Создать функцию `get_high_value_clients(min_total NUMERIC)`

Которая:

возвращает таблицу:

- id клиента
- ФИО
- сумму заказов

только для клиентов с суммой выше `min_total`.

> Использовать RETURNS TABLE.

### Задание 5

Создать функцию `increase_salary_by_department(p_department TEXT, p_percent NUMERIC)`

Которая:

- увеличивает зарплату сотрудникам указанного отдела
- возвращает количество обновлённых строк

Использовать:

- UPDATE
- RETURNING
- переменную для подсчёта

## Контрольные вопросы

1. Что такое хранимая функция и где она хранится?
2. Чем отличается функция от процедуры в PostgreSQL?
3. В чём разница между LANGUAGE SQL и LANGUAGE plpgsql?
4. Что произойдёт, если тип возврата функции не соответствует фактическому результату?
5. Как вернуть несколько строк из функции?
6. Почему функции могут использоваться для ограничения доступа к данным?
7. Что такое переменная в PL/pgSQL и как она объявляется?
8. Когда перенос бизнес-логики в БД оправдан, а когда нет?