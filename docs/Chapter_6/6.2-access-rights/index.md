# Права доступа

**Тип:** лекция

## 1. Общая модель разграничения доступа

В PostgreSQL используется модель RBAC (Role-Based Access Control):

- доступ выдаётся ролям
- роли могут быть пользователями или группами
- права назначаются на объекты

> Без выданных привилегий пользователь не может работать с объектом.

## 2. Объекты, к которым применяются права

Права можно назначать на:

- базы данных
- схемы
- таблицы
- представления
- функции
- последовательности
- процедуры

## 3. Основные типы привилегий

### Для таблиц

1. SELECT - чтение данных
2. INSERT - добавление строк
3. UPDATE - изменение строк
4. DELETE - удаление строк
5. TRUNCATE - очистка таблицы
6. REFERENCES - создание внешних ключей
7. TRIGGER - создание триггеров

### Для базы данных

|Привилегия |	Назначение                  |
|-----------|-------------------------------|
|CONNECT    |	Подключение к БД            |
|CREATE     |	Создание объектов           |
|TEMPORARY  |	Создание временных таблиц   |

### Для схемы
|Привилегия     |	Назначение              |
|---------------|---------------------------|
|USAGE          |	Доступ к объектам схемы |
|CREATE         |	Создание объектов       |

### Для функций

1. EXECUTE - выполнение функции

## 4. Команда GRANT

### Общий синтаксис:

```sql
GRANT privilege
ON object
TO role;
```

### Пример для таблицы

```sql
GRANT SELECT ON employees TO analyst;
```

### Несколько прав
GRANT SELECT, INSERT, UPDATE
ON employees
TO manager;

## 5. REVOKE — отзыв прав

```sql
REVOKE INSERT ON employees FROM analyst;
```

Можно отозвать все права:

```sql
REVOKE ALL ON employees FROM analyst;
```

## 6. Права на все объекты схемы

```sql
GRANT SELECT
ON ALL TABLES IN SCHEMA public
TO analyst;
```

> Это не распространяется на будущие таблицы.

## 7. Права по умолчанию

Чтобы права автоматически назначались на будущие объекты:

```sql
ALTER DEFAULT PRIVILEGES
IN SCHEMA public
GRANT SELECT ON TABLES TO analyst;
```

### 8. PUBLIC

PUBLIC — специальная роль, включающая всех пользователей.

Если выполнить `GRANT SELECT ON employees TO PUBLIC;`

Все пользователи получат доступ.

> Рекомендуется ограничивать `PUBLIC`:

```sql
REVOKE ALL ON SCHEMA public FROM PUBLIC;
```

## 9. Владение объектами

Владелец:

- имеет полный контроль
- может выдавать права
- может удалять объект

Изменение владельца:

```sql
ALTER TABLE employees OWNER TO admin_role;
```

## 10. WITH GRANT OPTION

Позволяет пользователю передавать право дальше:

```sql
GRANT SELECT ON employees
TO analyst
WITH GRANT OPTION;
```

> Может создавать сложную иерархию прав.

## 11. Проверка прав

В psql:

```sql
\z employees
```

Показать роли:

```sql
\du
```

## 12. Типичные сценарии доступа

Аналитик

- SELECT
- EXECUTE функций

Приложение

- SELECT
- INSERT
- UPDATE

Администратор

- ALL PRIVILEGES
- CREATEDB
- CREATEROLE

## 13. Принцип наименьших привилегий

> Пользователь должен иметь минимально необходимый доступ.

Это предотвращает:

- утечки
- случайные изменения
- удаление данных

## 14. Частые ошибки

|Ошибка                         |	Причина                     |
|-------------------------------|-------------------------------|
|Использование SUPERUSER        |	Нарушение безопасности      |
|Права через PUBLIC             |	Потенциальная утечка        |
|Выдача ALL PRIVILEGES          |	Избыточность                |
|Отсутствие DEFAULT PRIVILEGES  |	Проблемы с новыми таблицами |

## 15. Права и представления

Можно:
- дать SELECT на VIEW
- не давать доступ к исходной таблице

Это создаёт уровень абстракции и безопасности.

## 16. Права и функции

Можно разрешить EXECUTE без доступа к таблицам.

> Это позволяет скрыть структуру данных.

## 17. Права и RLS

Даже при наличии SELECT, RLS может ограничить строки.

RLS — дополнительный уровень защиты.

## 18. Архитектурный вывод

Права доступа:

- реализуют разграничение ответственности
- защищают данные
- поддерживают безопасную архитектуру
- должны проектироваться заранее

19. Выводы

Права доступа:

- управляются через GRANT / REVOKE
- назначаются на конкретные объекты
- должны выдаваться по принципу минимальности
- являются основой безопасности БД

## Домашнее задание

Предметная область: 
- employees
- clients
- orders

### Задание 1. Базовые привилегии

Создать роль analyst_role.

Дать ей право:

- SELECT
- на таблицы employees, clients, orders.

Проверить:

- что SELECT работает
- что INSERT вызывает ошибку

> Зафиксировать ошибку и объяснить причину.

### Задание 2. Частичный доступ
Дать роли `app_user_role` права:

`SELECT`, `INSERT`, `UPDATE`
только на таблицу orders.

Проверить невозможность доступа к employees.

> Объяснить принцип минимальных привилегий.

### Задание 3. Работа со схемой
Отозвать у PUBLIC права на схему public.

Дать `analyst_role` право USAGE на схему.

Проверить подключение и доступ.

> Объяснить разницу между:

- USAGE
- SELECT

### Задание 4. WITH GRANT OPTION

Выдать:

```sql
GRANT SELECT ON employees TO analyst_role WITH GRANT OPTION;
```

Под ролью аналитика передать право другому пользователю.

Проверить цепочку прав.

> Объяснить риски использования GRANT OPTION.

### Задание 5. DEFAULT PRIVILEGES
Настроить:

```sql
ALTER DEFAULT PRIVILEGES
IN SCHEMA public
GRANT SELECT ON TABLES TO analyst_role;
```

Создать новую таблицу.

Проверить, получил ли аналитик доступ автоматически.

> Объяснить, зачем это используется в промышленной среде.

### Задание 6 

Создать `VIEW` для аналитиков.

Дать `SELECT` на `VIEW`.

Отозвать доступ к исходной таблице.

Проверить, что доступ к данным сохраняется через представление.

> Объяснить архитектурное преимущество такого подхода.

## Контрольные вопросы

1. В чём разница между ролью и пользователем?
2. Какие права можно выдать на таблицу?
3. Чем отличается USAGE на схему от SELECT на таблицу?
4. Что делает команда REVOKE?
5. Что такое WITH GRANT OPTION и чем он опасен?
6. Что такое DEFAULT PRIVILEGES?
7. Почему не рекомендуется использовать SUPERUSER в приложении?
8. Как проверить текущие привилегии на объект?
9. Почему PUBLIC может быть угрозой безопасности?
10. В чём заключается принцип наименьших привилегий?