# Практическое занятие 9. Функции с параметрами

**Цель:** сформировать навыки создания функций с входными параметрами; использования параметров в SQL и PL/pgSQL; работы с типами возврата; обработки NULL; возврата таблиц из функций

## Исходная модель данных

```sql
employees (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    salary NUMERIC,
    department TEXT
);

clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    city TEXT,
    status TEXT
);

orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE,
    total_amount NUMERIC
);
```

## Задание 1.

Создать функцию `get_employee_salary(p_id INT)`

Которая:

- возвращает зарплату сотрудника по id
- если сотрудник не найден — возвращает NULL

> Использовать LANGUAGE SQL.

## Задание 2

Создать функцию `get_department_avg_salary(p_department TEXT)`

Которая возвращает среднюю зарплату отдела, если сотрудников нет — возвращает 0

> Обработать NULL.

## Задание 3

Создать функцию `get_client_total(p_client_id INT)`

Которая вычисляет сумму заказов клиента, если заказов нет — возвращает 0

Использовать:

- переменную
- SELECT INTO
- RETURN

## Задание 4

Создать функцию get_client_level(p_client_id INT)

Которая:

- если сумма заказов > 100 000 → 'VIP'
- если > 50 000 → 'Regular'
иначе → 'New'

> Использовать IF / ELSIF.

## Задание 5

Создать функцию `increase_salary(p_department TEXT, p_percent NUMERIC)`

Которая:

- увеличивает зарплату сотрудникам указанного отдела
- возвращает количество изменённых строк

Использовать `UPDATE`; `GET DIAGNOSTICS` или `RETURNING`

## Задание 6

Создать функцию `get_orders_by_period(p_date_from DATE, p_date_to DATE)`

Которая возвращает таблицу заказов за указанный период

Использовать:

- RETURNS TABLE
- RETURN QUERY

## Задание 7

Создать функцию `safe_update_salary(p_id INT, p_new_salary NUMERIC)`

Которая запрещает устанавливать зарплату меньше 30 000 при нарушении — выбрасывает EXCEPTION

## Задание 8

Создать функцию `assign_client_status(p_client_id INT)`

Которая:

- Вычисляет сумму заказов
- Определяет статус
- Обновляет таблицу clients
- Возвращает новый статус

Использовать:
- переменные
- SELECT INTO
- UPDATE
- IF
- RETURN

## Индивидуальные задания

**Вариант 1.** Функция расчёта годовой премии сотрудника.
**Вариант 2.** Функция, возвращающая сотрудников отдела с зарплатой выше среднего.
**Вариант 3.** Функция, возвращающая количество заказов клиента за год.
**Вариант 4.** Функция изменения статуса клиента в зависимости от города.
**Вариант 5.** Функция, возвращающая максимальный заказ клиента.