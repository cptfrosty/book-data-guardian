# Практическое занятие 11. Триггеры бизнес-логики

**Цель:** научить студентов: реализовывать бизнес-правила через триггеры; автоматически изменять связанные данные; использовать `AFTER` и `BEFORE` триггеры осознанно; понимать риски скрытой логики; избегать рекурсии и логических ошибок

## Исходная предметная область

Система продаж:

```sql
clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    city TEXT,
    status TEXT
);

orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE,
    total_amount NUMERIC
);

order_items (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id),
    product_name TEXT,
    quantity INT,
    price NUMERIC
);
```

## Задание 1

Создать триггер при добавлении строки в `order_items`, автоматически пересчитывать orders.total_amount

Использовать:

- AFTER INSERT OR UPDATE OR DELETE
- агрегат SUM(quantity * price)

## Задание 2

Обеспечить корректную работу при удалении позиции заказа и изменении количества

## Задание 3

Создать триггер если сумма заказов клиента превышает 100 000, автоматически установить status = 'VIP'

> Использовать AFTER INSERT ON orders.

## Задание 4

Дополнить логику:

- если сумма < 50 000 → 'New'
- 50 000–100 000 → 'Regular'

> Вся логика должна находиться в триггерной функции.

## Задание 5

Запретить создание заказа клиентом со статусом 'Blocked'

> Использовать BEFORE INSERT.

## Задание 6

Запретить удаление заказа, если он старше 30 дней

> Использовать сравнение дат.

## Задание 7

Реализовать при удалении заказа автоматически перерасчёт статус клиента

> Убедиться, что логика работает корректно в обе стороны.

## Задание 8

Реализовать логирование изменения статуса клиента в таблицу `client_status_log`

```sql
client_status_log (
    client_id INT,
    old_status TEXT,
    new_status TEXT,
    changed_at TIMESTAMP
);
```

> Использовать AFTER UPDATE с условием WHEN.


## Индивидуальные задания

**Вариант 1.** Автоматически начислять бонус клиенту при заказе > 200 000.

**Вариант 2.** Запретить создание заказа без товаров.

**Вариант 3.** Переводить клиента в статус 'Inactive', если нет заказов более года.

**Вариант 4.** Ограничить максимальное количество заказов в месяц.

**Вариант 5.** Реализовать автоматический пересчёт среднего чека клиента.