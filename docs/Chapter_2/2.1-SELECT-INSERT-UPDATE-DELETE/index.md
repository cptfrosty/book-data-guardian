# Лекция 2.1. SELECT, INSERT, UPDATE, DELETE

**Тип занятия:** лекция

**Объём:** 2 академических часа

## 1. SQL как язык управления данными

SQL (Structured Query Language) — декларативный язык работы с реляционными базами данных.

Ключевая идея:
>Мы не описываем, как получать данные,
>мы описываем, какие данные нужны.

Операторы SELECT, INSERT, UPDATE, DELETE относятся к группе DML (Data Manipulation Language).

## 2. SELECT — выборка данных

Оператор SELECT используется для чтения данных из таблиц и представлений.

Важно: SELECT не изменяет данные.

### Базовый синтаксис

```sql
SELECT column1, column2
FROM table_name;
```

или

```sql
SELECT *
FROM table_name;
```

> **Внимание:**

> использование * допустимо только в учебных примерах.

### Фильтрация данных (WHERE)

```sql
SELECT *
FROM employees
WHERE salary > 50000;
```

Условия:

- `=`, `<`, `>`, `<=`, `>=`
- `AND`, `OR`, `NOT`
- `IN`, `BETWEEN`, `LIKE`, `IS NULL`

### Сортировка (ORDER BY)

```sql
SELECT full_name, salary
FROM employees
ORDER BY salary DESC;
```

Сортировка выполняется после фильтрации.

### Ограничение количества строк

```sql
SELECT *
FROM employees
LIMIT 10 OFFSET 20;
```

## 3. INSERT — добавление данных

Оператор INSERT используется для вставки новых строк в таблицу.

### Вставка одной строки

```sql
INSERT INTO employees (full_name, salary)
VALUES ('Иванов Иван', 60000);
```

Если столбец не указан:

- используется DEFAULT
- либо возникает ошибка (NOT NULL)

### Вставка нескольких строк

```sql
INSERT INTO employees (full_name, salary)
VALUES
('Петров Пётр', 55000),
('Сидоров Сергей', 70000);
```

### INSERT с SELECT

```sql
INSERT INTO archive_employees (full_name, salary)
SELECT full_name, salary
FROM employees
WHERE salary < 40000;
```

Часто используется для архивирования данных.

## 4. UPDATE — изменение данных

Оператор UPDATE изменяет существующие строки.

### Базовый синтаксис

```sql
UPDATE employees
SET salary = 65000
WHERE id = 3;
```

> **Внимание**

> критическая ошибка: UPDATE без WHERE

```sql
UPDATE employees
SET salary = 0;
```

Изменит все строки таблицы.

### Обновление нескольких столбцов

```sql
UPDATE employees
SET
    salary = salary * 1.1,
    updated_at = CURRENT_DATE
WHERE department_id = 2;
```

### UPDATE с подзапросом

```sql
UPDATE employees
SET salary = salary * 1.05
WHERE department_id IN (
    SELECT id
    FROM departments
    WHERE name = 'IT'
);
```

## 5. DELETE — удаление данных

Оператор DELETE удаляет строки из таблицы.

### Базовый синтаксис
```sql
DELETE FROM employees
WHERE id = 5;
```

### DELETE без WHERE

```sql
DELETE FROM employees;
```

Удаляет все строки, но:

- структура таблицы сохраняется
- можно откатить в транзакции

### DELETE и каскады

```sql
DELETE FROM departments
WHERE id = 1;
```

Поведение зависит от:
- `ON DELETE CASCADE`
- `RESTRICT`
- `SET NULL`

## Транзакционный аспект
Все DML-операции могут выполняться в транзакции:

```sql
BEGIN;

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

ROLLBACK; -- или COMMIT
```

Без COMMIT изменения не сохраняются.

## Типичные ошибки

|Ошибка                 |Последствие            |
|-----------------------|-----------------------|
|UPDATE без WHERE       | Массовая порча данных |
|DELETE без WHERE       | Потеря данных         |
|Несоответствие типов   | Ошибка выполнения     |
|Нарушение ограничений  | Ошибка целостности    |

## Сравнение операторов

|Оператор| Назначение   | Изменяет данные   |
|------|----------------|-------------------|
|SELECT| Чтение         |	Нет             |
|INSERT| Добавление     |	Да              |
|UPDATE| Изменение      |	Да              |
|DELETE| Удаление       |	Да              |

## Выводы

`SELECT` — самый сложный оператор логически

`INSERT` проверяет ограничения целостности

`UPDATE` и `DELETE` требуют строгого контроля

Все операции должны выполняться осознанно

## Домашнее задание №1

Создайте таблицу employees (структуру можно взять из практики или задать самостоятельно).

Требуется написать 5 запросов SELECT:

- Вывести всех сотрудников, у которых зарплата выше средней по таблице
- Вывести сотрудников без отдела (department_id IS NULL)
- Найти сотрудников, принятых за последний год
- Вывести топ-3 сотрудников по зарплате
- Вывести сотрудников, у которых имя начинается на одну букву и заканчивается на другую

## Домашнее задание №2

Даны таблицы:

- departments
- employees

Требуется:

- Добавить новый отдел
- Добавить в него минимум 3 сотрудников
- Повысить зарплату всем сотрудникам отдела на 10%
- Перевести одного сотрудника в другой отдел
- Зафиксировать состояние таблиц до и после изменений

Ограничение:

- все изменения выполнить в одной транзакции
- показать вариант с ROLLBACK и с COMMIT

## Домашнее задание №3

Дана предметная область:

> Увольнение сотрудника не должно приводить к потере истории.

Требуется:

- Реализовать таблицу employees_archive
- Скопировать туда данные уволенного сотрудника
- Удалить сотрудника из основной таблицы
- Убедиться, что данные сохранены в архиве

Запрещено:

- использовать триггеры
- использовать каскадное удаление

> # Подсказка: 
> используйте `INSERT INTO ... SELECT`
> затем `DELETE`


## Контрольные вопросы

1. Чем принципиально отличается `SELECT` от `INSERT`, `UPDATE`, `DELETE` с точки зрения работы СУБД?
2. Почему выполнение `UPDATE` или `DELETE` без условия `WHERE` считается критической ошибкой?
3. В чём разница между `DELETE FROM table;` и `DELETE FROM table WHERE condition;`?
4. Что произойдёт при выполнении `INSERT`, если нарушается ограничение целостности?
5. Зачем выполнять DML-операции в транзакции?