# Практическое занятие 7. Сложные аналитические запросы

**Цель:** научить студентов строить многоуровневые аналитические SELECT-запросы; комбинировать JOIN + GROUP BY + HAVING; использовать CTE для декомпозиции логики; сравнивать показатели (выше среднего, максимум в группе); анализировать данные по периодам

## Исходная предметная область

Модель продаж

```sql
clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    city TEXT
);

orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE
);

order_items (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id),
    product_name TEXT,
    quantity INT,
    price NUMERIC
);
```

> Заполните таблицы тестовыми данными

## Задание 1

Вывести:

- клиента
- количество заказов
- общую сумму
- средний чек

Требования:

- минимум 2 JOIN
- GROUP BY
- минимум 2 агрегатные функции

## Задание 2
Найти клиентов у которых сумма заказов выше средней по всем клиентам

Использовать подзапрос или CTE

## Задание 3

Вывести:

- месяц
- общую выручку
- количество заказов

Использовать:

```sql
DATE_TRUNC('month', order_date)
```

## Задание 4

Найти месяц с максимальной выручкой

> Использовать вложенный запрос или CTE.

## Задание 5

Найти клиентов чья сумма заказов выше средней по их городу

> Подсказка:

> CTE с агрегацией по городу, затем сравнение

## Задание 6

Найти товары которые продаются чаще среднего количества по всем товарам

## Задание 7

Найти клиентов у которых есть заказы за последние 3 месяца

> Использовать EXISTS.

## Задание 8

Найти клиентов у которых не было заказов за последний год

> Использовать NOT EXISTS или LEFT JOIN + IS NULL

Сравнить подходы.

## Задание 9

Вывести:
- город
- количество клиентов
- общую выручку
- средний чек
- долю города в общей выручке (%)

> Использовать: CTE минимум 2 уровня агрегации

## Задание 10 

Вывести:

- клиента
- дату последнего заказа
- сумму последнего заказа
- общее количество заказов

> Разрешено использовать: CTE, подзапрос, JOIN

## Индивидуальные задания

**Вариант 1.** Найти клиента с наибольшим средним чеком.

**Вариант 2.** Найти город с минимальной выручкой.

**Вариант 3.** Найти товар, который принёс максимальную выручку.

**Вариант 4.** Найти клиентов, сделавших заказы в разные месяцы.

**Вариант 5.** Найти клиентов, количество заказов которых выше среднего.