# Практическое занятие 6. Комплексные SELECT-запросы

**Тип:** практическое занятие

**Продолжительность:** 2 академических часа

**Цель:** Научить студентов строить сложные SELECT-запросы, которые объединяют несколько таблиц; используют агрегатные функции; содержат подзапросы; применяют фильтрацию до и после группировки; корректно обрабатывают NULL.

## Исходная модель данных

Система учёта заказов

```sql
CREATE TABLE clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL,
    city TEXT
);

CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id),
    product_name TEXT,
    quantity INT,
    price NUMERIC
);
```

> Необходимо заполнить таблицу 10-20+ строк данными

## Задание 1

Вывести:

- ФИО клиента
- количество заказов
- общую сумму заказов

Требуется:

- минимум 2 JOIN
- GROUP BY

## Задание 2

Вывести клиентов:

- у которых сумма заказов больше 100 000
- отсортировать по сумме

> Использовать HAVING.

## Задание 3

Найти клиентов чья сумма заказов больше средней по всем клиентам.

> Использовать подзапрос в HAVING или WHERE.

## Задание 4

Найти заказ с максимальной суммой.

## Задание 5

Вывести клиентов у которых есть хотя бы один заказ дороже 50 000.

> Использовать EXISTS.

## Задание 6

Вывести клиентов у которых нет заказов.

Использовать: `LEFT JOIN` + `IS NULL` или `NOT EXISTS`

В отчёте сравнить два варианта в таблице

Задание 7

Вывести:

- город
- количество клиентов
- общую сумму заказов
- средний чек

Условия:

- учитывать только клиентов с заказами
- отсортировать по сумме

## Задание 8

Вывести:

- клиента
- дату его последнего заказа
- сумму последнего заказа

> использовать подзапрос или JOIN с агрегированным результатом

## Задание 9

Написать два запроса:

- с LEFT JOIN
- с INNER JOIN

Сравнить количество строк в результате и объяснить различие.

## Задание 10

Исправить запрос

```sql
SELECT c.full_name, SUM(quantity * price)
FROM clients c
JOIN orders o ON o.client_id = c.id
JOIN order_items oi ON oi.order_id = o.id
WHERE SUM(quantity * price) > 100000
GROUP BY c.full_name;
```


## Индивидуальные задания

**Вариант 1.** Найти клиента с минимальной суммой заказов.

**Вариант 2.** Найти город с максимальной выручкой.

**Вариант 3.** Найти товар, который принёс наибольшую выручку.

**Вариант 4.** Найти клиентов, у которых заказы были в разные месяцы.

**Вариант 5.** Найти клиентов, которые сделали больше заказов, чем среднее значение.