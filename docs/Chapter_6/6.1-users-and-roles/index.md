## Пользователи и роли в PostgreSQL

**Тип:** лекция

## 1. Основы модели безопасности PostgreSQL

В PostgreSQL используется ролевая модель доступа (Role-Based Access Control, RBAC).

> Ключевое понятие:

> В PostgreSQL нет отдельного объекта “пользователь” — есть роли.

Роль может:

- входить в систему
- быть группой ролей
- владеть объектами
- иметь права доступа

## 2. Что такое роль

**Роль** — это объект, которому можно:

- назначать привилегии
- передавать владение объектами
- давать право входа в систему

3. Создание роли

```sql
CREATE ROLE analyst;
```

Роль без возможности входа.

Роль с правом входа

```sql
CREATE ROLE manager
WITH LOGIN
PASSWORD 'secure_password';
```

> Теперь это фактически пользователь.

## 4. Основные атрибуты ролей

|Атрибут        |	Назначение              |
|---------------|---------------------------|
|LOGIN          |	Разрешает подключение   |
|SUPERUSER      |	Полный доступ           |
|CREATEDB       |	Может создавать БД      |
|CREATEROLE     |	Может создавать роли    |
|REPLICATION    |	Для репликации          |
|BYPASSRLS      |	Обход Row Level Security|

Пример:

```sql
CREATE ROLE admin
WITH LOGIN
SUPERUSER;
```

## 5. Изменение роли

```sql
ALTER ROLE manager WITH CREATEDB;
```

## 6. Удаление роли

```sql
DROP ROLE analyst;
```

> Нельзя удалить роль, если она владеет объектами.

## 7. Владение объектами

Каждый объект БД имеет владельца.

```sql
ALTER TABLE employees OWNER TO manager;
```

Владелец может:

- изменять структуру
- удалять объект
- передавать права

8. Привилегии (GRANT)

Основная команда:

```sql
GRANT privilege
ON object
TO role;
```

### Права на таблицу
|Привилегия | Значение              |
|-----------|-----------------------|
|SELECT     |	Чтение              |
|INSERT     |	Вставка             |
|UPDATE     |	Обновление          |
|DELETE     |	Удаление            |
|TRUNCATE   |	Очистка             |
|REFERENCES |	Создание FK         |
|TRIGGER    |	Создание триггеров  |

Пример:

```sql
GRANT SELECT ON employees TO analyst;
```

### Права на все таблицы схемы

```sql
GRANT SELECT ON ALL TABLES IN SCHEMA public TO analyst;
```

## 9. REVOKE

Отзыв прав:

```sql
REVOKE SELECT ON employees FROM analyst;
```

## 10. Групповые роли

Можно создавать роль-группу:

```sql
CREATE ROLE developers;
```

Добавить пользователя в группу:

```sql
GRANT developers TO manager;
```

> Удобно для управления доступом.

## 11. PUBLIC

PUBLIC — специальная роль.

Права, выданные PUBLIC, получают все пользователи.

> Часто нужно ограничивать PUBLIC.

## 12. По умолчанию

При создании таблицы:

- доступ есть только у владельца
- PUBLIC может иметь некоторые базовые права

Рекомендуется:

```sql
REVOKE ALL ON SCHEMA public FROM PUBLIC;
```

## 13. Row Level Security (RLS)

Позволяет ограничить доступ к строкам таблицы.

Включение:

```sql
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
```

Создание политики:

```sql
CREATE POLICY employee_policy
ON employees
FOR SELECT
USING (department = current_user);
```

> Пользователь видит только свои данные.

## 14. Проверка прав

Посмотреть роли:

```sql
\du
```

Посмотреть права на таблицу:

```sql
\z table_name
```

## 15. Принцип наименьших привилегий

Пользователь должен иметь только те права, которые ему необходимы.

Это снижает риск:

- утечки данных
- случайного удаления
- злоупотребления доступом

## 16. Типичная архитектура ролей

В реальной системе создаются:

- admin — администрирование
- app_user — доступ приложению
- analyst — только SELECT
- readonly — только чтение

## 17. Частые ошибки

|Ошибка	Причина
|Использование SUPERUSER	Опасно
|Права через PUBLIC	Нарушение безопасности
|Отсутствие групповых ролей	Сложность администрирования
|Игнорирование RLS	Утечка данных

## 18. Безопасность и функции

Можно дать доступ только к функции:

```sql
GRANT EXECUTE ON FUNCTION get_client_total(INT) TO analyst;
```

> Пользователь выполняет функцию, не имея доступа к таблице.

## 19. Выводы

Роли и пользователи:

- реализуют модель RBAC
- управляются через CREATE ROLE / GRANT / REVOKE
- поддерживают иерархию
- позволяют ограничивать доступ к объектам и строкам
- являются основой безопасности БД

## Домашнее задание

Предметная область:

- employees
- clients
- orders

## Задание 1. Создание ролей

Создать роли:

- admin_role
- analyst_role
- app_user_role

Назначить:

- admin_role → LOGIN, CREATEDB
- analyst_role → без LOGIN
- app_user_role → LOGIN

 Проверить список ролей через `\du`.

## Задание 2. Групповая модель доступа

Добавить пользователя ivan в роль analyst_role.

Добавить пользователя app_service в app_user_role.

> Объяснить: зачем использовать групповые роли

## Задание 3. Назначение привилегий

Дать `analyst_role` права:

```sql
SELECT
```

на таблицы:

- `employees`
- `clients`
- `orders`

Проверить доступ под пользователем ivan.

Попробовать выполнить INSERT — зафиксировать ошибку.

## Задание 4. Ограничение доступа

Отозвать у PUBLIC все права на схему public.

Проверить, что новый пользователь не может получить доступ без GRANT.

> Объяснить принцип наименьших привилегий.

## Задание 5. Владение объектами

Передать владение таблицей `orders` роли `admin_role`.

Проверить, кто является владельцем.

> Объяснить разницу между владельцем и пользователем с правами `SELECT`.

## Задание 6. EXECUTE для функции

Создать функцию `get_total_orders()`.

Дать `analyst_role` право `EXECUTE`.

Отозвать прямой доступ к таблице `orders`.

Проверить, может ли аналитик выполнять функцию.

## Задание 7 

Включить RLS для таблицы employees.

Создать политику:

- пользователь видит только сотрудников своего отдела.

Использовать:

```sql
ENABLE ROW LEVEL SECURITY;
CREATE POLICY ...
```

> Объяснить, как работает фильтрация строк.