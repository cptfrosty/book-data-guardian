# Практическое занятия 5. Аналитические выборки (GROUP BY, HAVING, подзапросы, базовая аналитика)

**Продолжительность:** 2 академических часа

**Тип:** практическое занятие

**Цель:** Научить студентов выполнять агрегированные выборки; использовать GROUP BY и HAVING; применять подзапросы в аналитике; сравнивать показатели (больше среднего, максимум в группе и т.д.); анализировать данные. 

## Исходная предметная область

```sql
CREATE TABLE clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL
);

CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id),
    product_name TEXT,
    quantity INT,
    price NUMERIC
);
```

> Таблицы необходимо предварительно заполнить тестовыми данными.

## Этап 1. Базовая агрегированная аналитика
### Задание 1

Определить общее количество заказов.

### Задание 2

Определить общую сумму продаж.

Подсказка:

```sql
SUM(quantity * price)
```

### Задание 3

Найти среднюю сумму одного заказа.

## Этап 2. GROUP BY
### Задание 4

Вывести количество заказов по каждому клиенту.

### Задание 5

Вывести общую сумму заказов по каждому клиенту.

### Задание 6

Найти клиентов у которых сумма заказов больше 100 000.

> Использовать HAVING.

## Этап 3. Подзапросы в аналитике
### Задание 7

Найти клиентов у которых сумма заказов больше средней по всем клиентам.

> Использовать подзапрос.

### Задание 8

Найти заказ с максимальной суммой.

### Задание 9

Найти клиента с наибольшей общей выручкой.

## Этап 4. Аналитика с JOIN
### Задание 10

Вывести:

- ФИО клиента
- количество заказов
- общую сумму
- средний чек

> Использовать минимум:

> 1 JOIN

> 2 агрегатные функции

## Этап 5. Сложная аналитическая выборка
### Задание 11

Вывести клиентов, у которых количество заказов выше среднего, отсортировать по сумме покупок.

### Задание 12

Найти товары, которые продавались более чем в 5 заказах.

### Индивидуальные задания (на оценку)

**Вариант 1.** Найти клиента с минимальной суммой заказов.

**Вариант 2.** Найти месяц с наибольшей выручкой.

**Вариант 3.** Найти клиентов без заказов.

**Вариант 4.** Найти средний чек по месяцам.

**Вариант 5.** Найти клиентов, у которых последний заказ был более года назад.