# Практическое занятие 15. Бэкап и восстановление

**Цель:** научить студентов выполнять логическое резервное копирование, восстанавливать базу полностью и частично, сравнивать форматы бэкапа, проверять корректность восстановления, понимать различие логического и физического бэкапа

## Подготовка

Создать тестовую базу данных:

```sql
createdb company_db
```

Создать таблицы и заполнить данными:

- employees
- clients
- orders

> добавить не менее 1000 строк.

## Задание 1. SQL-формат

Выполнить:

```sql
pg_dump -U postgres company_db > company_backup.sql
```

Проверить:

- размер файла
- читаемость (открыть в редакторе)

## Задание 2. Custom-формат

```sql
pg_dump -U postgres -Fc company_db -f company_backup.dump
```

Сравнить:

- размер файла
- содержимое (не текстовый формат)

## Задание 3. Восстановление из SQL

Создать новую БД:

```sql
createdb company_restore
```

Восстановить:

```sql
psql -U postgres -d company_restore < company_backup.sql
```

Проверить:

- список таблиц
- количество строк

## Задание 4. Восстановление через pg_restore

Удалить базу и создать заново.

```sql
pg_restore -U postgres -d company_restore company_backup.dump
```

Сравнить скорость восстановления.

## Задание 5

Создать бэкап только таблицы employees:

```sql
pg_dump -U postgres -t employees company_db > employees_backup.sql
```

Создать новую БД и восстановить только эту таблицу.

Проверить структуру и данные.

## Задание 6

Удалить таблицу `orders`.

Попробовать восстановить её из бэкапа.

Проверить результат.

Объяснить почему важно тестировать восстановление.

## Задание 7

Выполнить:

```sql
pg_basebackup -U postgres -D /tmp/basebackup -Fp -Xs -P
```

Объяснить:

- что копируется
- зачем нужны WAL
- чем отличается от pg_dump

## Задание 8

Смоделировать ситуацию:

- база 100 ГБ
- 24/7 работа
- допустимая потеря данных — 10 минут

Ответить:

- использовать ли только pg_dump?
- нужно ли архивирование WAL?
- как часто делать base backup?

## Индивидуальные задания

**Вариант 1.** Создать автоматизированный скрипт бэкапа.

**Вариант 2.** Настроить ротацию файлов (ежедневные копии).

**Вариант 3.** Восстановить базу в новую среду.

**Вариант 4.** Создать стратегию резервирования для интернет-магазина.

**Вариант 5.** Рассчитать RPO и RTO для учебной системы.