# Практическое занятие 16

**Цель:** Проверить умение студента проектировать структуру БД; реализовывать ограничения целостности; писать сложные SQL-запросы использовать функции или триггеры; обеспечивать безопасность (роли и права); анализировать производительность

## Предметная область

Разработать БД для системы управления заказами интернет-магазина.

Задание 1. Проектирование структуры
Требуется создать таблицы:

users:

- id (PK)
- full_name
- email (UNIQUE)
- role
- created_at

products

- id (PK)
- name
- price
- stock_quantity
- category

orders:

- id (PK)
- user_id (FK)
- order_date
- total_amount
- status

order_items

- id (PK)
- order_id (FK)
- product_id (FK)
- quantity
- price

Требования:

- использовать PRIMARY KEY
- использовать FOREIGN KEY
- настроить ON DELETE CASCADE
- добавить CHECK (price > 0, quantity > 0)
- добавить NOT NULL где необходимо

## Задание 2. Бизнес-логика

Необходимо реализовать один из вариантов:

Вариант A (через триггер). При добавлении строки в `order_items` автоматически пересчитывать orders.total_amount

Вариант B (через функцию). Создать функцию `calculate_order_total(order_id INT)` которая пересчитывает сумму заказа.

> Обязательно использовать PL/pgSQL.

## Задание 3. SQL-запросы

Написать и продемонстрировать:

- Список заказов пользователя
- Топ-5 самых продаваемых товаров
- Сумму продаж по категориям
- Количество заказов по статусам
- Пользователей без заказов

> Использовать JOIN, GROUP BY, агрегатные функции.

## Задание 4. Оптимизация

Проанализировать один сложный запрос через `EXPLAIN ANALYZE`

Создать минимум 2 индекса.

Показать изменение плана выполнения.

## Задание 5. Транзакция

Реализовать сценарий:

- создание заказа
- добавление товаров
- уменьшение stock_quantity

> Всё в одной транзакции. При ошибке — откат.

## Задание 6. Защита БД

Создать роли:

- admin
- manager
- analyst_role

Настроить:

|Роль   | Права                 |
|-------|-----------------------|
|admin  | ALL                   |
|manager| INSERT/UPDATE/SELECT  |
|analyst| SELECT                |

> Ограничить доступ к изменению products.price только admin.

## Задание 7. Резервное копирование

- Создать логический бэкап базы.
- Восстановить его в новую БД.
- Проверить целостность данных.

## Дополнительное задание

**Вариант 1:** Реализовать RLS для пользователей

**Вариант 2:** Настроить SERIALIZABLE для критических операций

**Вариант 3:** Добавить логирование изменений цен
