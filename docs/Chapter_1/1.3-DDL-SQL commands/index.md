# DDL-команды SQL

**Тип занятия:** лекция

**Объём:** 2 академических часа

## 1. Назначение DDL

DDL (Data Definition Language) — подмножество SQL, предназначенное для:

- создания объектов базы данных
- изменения их структуры
- удаления объектов

DDL работает со схемой, а не с данными.

### Основные DDL-команды

|Команда    | Назначение            |
|-----------|-----------------------|
|CREATE     | Создание объектов     |
|ALTER      | Изменение структуры   |
|DROP       | Удаление объектов     |
|TRUNCATE   | Очистка таблицы       |
|COMMENT    | Документирование      |

## 2. CREATE — создание объектов БД

### CREATE DATABASE

```sql
CREATE DATABASE college_db;
```

Создаёт новую базу данных

Выполняется вне транзакции

### CREATE TABLE

```sql
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL,
    birth_date DATE,
    email TEXT UNIQUE
);
```

В момент создания таблицы:

- задаются типы данных
- задаются ограничения целостности
- формируется структура хранения

### CREATE TABLE IF NOT EXISTS

```sql
CREATE TABLE IF NOT EXISTS groups (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);
```

Защита от ошибки повторного создания

## 3. Ограничения в DDL

Ограничения — часть DDL, так как они определяют структуру данных.

Виды ограничений

- PRIMARY KEY
- FOREIGN KEY
- UNIQUE
- NOT NULL
- CHECK
- DEFAULT

```sql
salary NUMERIC CHECK (salary > 0) DEFAULT 30000
```

Ограничения можно:

- задавать на уровне столбца
- задавать на уровне таблицы

## 4. ALTER — изменение структуры таблицы

### Добавление столбца

```sql
ALTER TABLE students
ADD COLUMN phone TEXT;
```

### Удаление столбца

```sql
ALTER TABLE students
DROP COLUMN phone;
```

> Операция необратима без резервной копии

### Добавление ограничений

```sql
ALTER TABLE students
ADD CONSTRAINT students_email_check
CHECK (email LIKE '%@%');
```

СУБД проверяет все существующие данные

### Удаление ограничений

```sql
ALTER TABLE students
DROP CONSTRAINT students_email_check;
```

### Изменение типа данных

```sql
ALTER TABLE students
ALTER COLUMN phone TYPE VARCHAR(20);
```

> Возможна ошибка, если данные несовместимы

## 5. DROP — удаление объектов

### DROP TABLE

```sql
DROP TABLE students;
```

Удаляет:

- таблицу
- данные
- ограничения
- индексы

### DROP с зависимостями

```sql
DROP TABLE students CASCADE;
```

Удаляет все зависимые объекты

> Потенциально опасная операция

### DROP RESTRICT (по умолчанию)

```sql
DROP TABLE students RESTRICT;
```

Запрещает удаление при наличии зависимостей

## 6. TRUNCATE — очистка таблицы

```sql
TRUNCATE TABLE students;
```

Отличия от DELETE:

|DELETE             | TRUNCATE      |
|-------------------|---------------|
|DML                |	DDL         |
|Можно откатить     |	Нельзя      |
|Работает построчно |	Мгновенный  |
|Учитывает WHERE    |	Удаляет всё |

> TRUNCATE игнорирует ON DELETE

## 7. COMMENT — документирование схемы

```sql
COMMENT ON TABLE students IS 'Таблица студентов колледжа';
COMMENT ON COLUMN students.full_name IS 'ФИО студента';
```

Используется в промышленной разработке

Повышает читаемость схемы БД

## 8. Транзакции и DDL

Особенность:

- многие DDL-команды автоматически фиксируются
- ROLLBACK может не сработать

```sql
BEGIN;
CREATE TABLE test (id INT);
ROLLBACK; -- в PostgreSQL не откатит CREATE TABLE
```

Это критически важно для администрирования.

## Типичные ошибки

|Ошибка                         |	Последствие             |
|-------------------------------|---------------------------|
|DROP без анализа зависимостей  |	Потеря данных           |
|ALTER без проверки данных      |	Ошибка выполнения       |
|Отсутствие имён ограничений    |	Сложная поддержка       |
|TRUNCATE вместо DELETE         |	Безвозвратная очистка   |


## 10. Сравнение DDL и DML

|Критерий       |	DDL             |	DML             |
|---------------|-------------------|-------------------|
|Назначение     |	Структура       |	Данные          |
|Транзакции     |	Ограниченно     |	Полно           |
|Примеры        |	CREATE, ALTER   |	SELECT, INSERT  |

## Домашнее задание №1
Спроектируйте структуру БД для предметной области:

Учёт студентов и учебных групп колледжа.

Требуется (ТОЛЬКО DDL):

Создать таблицы:

- groups
- students

Реализовать:

- первичные ключи
- уникальность названия группы
- ФИО студента
- связь студент → группа (FOREIGN KEY)
- Задать осмысленные имена всем ограничениям

Добавить COMMENT:

- к таблицам
- к минимум 3 столбцам

Запрещено использовать INSERT, UPDATE, DELETE

## Домашнее задание №2

Дана таблица:
```sql
CREATE TABLE contracts (
    id SERIAL,
    number TEXT,
    start_date DATE,
    end_date DATE,
    client_id INT
);
```

Требуется:

Добавить первичный ключ

- Сделать номер договора уникальным
- Запретить NULL в start_date
- Добавить проверку `end_date > start_date`
- Добавить внешний ключ на таблицу clients
- Переименовать таблицу в client_contracts

Все изменения выполнить через ALTER TABLE

Указать порядок команд и объяснить его

## Домашнее задание №3

Создайте таблицу logs и заполните её тестовыми данными.

Затем:

- Очистите таблицу с помощью DELETE
- Повторно заполните таблицу
- Очистите таблицу с помощью TRUNCATE
- Попробуйте выполнить ROLLBACK в обоих случаях

В отчёте указать:

- какие операции откатились
- какие — нет
- почему TRUNCATE считается опасной командой

## Контрольные вопросы

1. В чём принципиальное отличие DDL-команд от DML-команд?
2. Что произойдёт при выполнении `CREATE TABLE` в транзакции и последующем `ROLLBACK`?
3. Почему добавление ограничения через `ALTER TABLE` может завершиться ошибкой?
4. В чём разница между `DELETE`, `TRUNCATE` и `DROP TABLE`?
5. Зачем задавать имена ограничениям (`CONSTRAINT name`)?
6. Чем опасно использование `DROP ... CASCADE`?
7. Можно ли изменить тип столбца через `ALTER TABLE` без потери данных?
8. Зачем использовать `COMMENT ON` в промышленной БД?