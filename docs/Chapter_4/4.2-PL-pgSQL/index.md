# PL/pgSQL

**Тип занятия:** лекция

**Продолжительность:** 2 академических часа

## 1. Что такое PL/pgSQL

**PL/pgSQL** — это встроенный процедурный язык PostgreSQL, который:

- используется внутри функций и триггеров
- позволяет писать логику с переменными, условиями и циклами
- выполняется на стороне сервера БД

> Если обычный SQL — декларативный язык, то PL/pgSQL — процедурный.

Используется для:

- реализации бизнес-логики
- сложных вычислений
- многошаговых операций
- проверок данных
- автоматизации операций

## 2. Общая структура функции на PL/pgSQL

```sql
CREATE FUNCTION function_name(parameters)
RETURNS return_type
LANGUAGE plpgsql
AS $$
DECLARE
    -- объявление переменных
BEGIN
    -- тело функции
END;
$$;
```

## 3. Блоки PL/pgSQL

### DECLARE

Объявление переменных:

```sql
DECLARE
    total NUMERIC;
    emp_count INT := 0;
```

### BEGIN ... END

Основной блок выполнения:

```sql
BEGIN
    -- действия
END;
```

## 4. Работа с переменными

### Присваивание

```sql
total := 1000;
```

### SELECT INTO

```sql
SELECT SUM(salary)
INTO total
FROM employees;
```

> В PL/pgSQL обязательно использовать INTO для записи результата в переменную.

## 5. Условные конструкции

### IF

```sql
IF total > 100000 THEN
    RETURN 'VIP';
ELSIF total > 50000 THEN
    RETURN 'Regular';
ELSE
    RETURN 'New';
END IF;
```

## 6. Циклы

### LOOP

```sql
LOOP
    -- действия
    EXIT WHEN condition;
END LOOP;
```

### WHILE

```sql
WHILE total < 100000 LOOP
    total := total + 1000;
END LOOP;
```

### FOR

```sql
FOR emp_record IN
    SELECT * FROM employees
LOOP
    RAISE NOTICE 'Employee: %', emp_record.full_name;
END LOOP;
```

> Часто используется для обработки набора строк.

## 7. Обработка ошибок

```sql
BEGIN
    -- код
EXCEPTION
    WHEN division_by_zero THEN
        RAISE NOTICE 'Ошибка деления на ноль';
END;
```

> Позволяет перехватывать исключения.

## 8. Возврат значений

### RETURN

```sql
RETURN total;
```

### RETURNS TABLE

```sql
CREATE FUNCTION get_employees()
RETURNS TABLE(id INT, full_name TEXT)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT id, full_name
    FROM employees;
END;
$$;
```

## 9. RAISE

Используется для вывода сообщений:

```sql
RAISE NOTICE 'Текущая сумма: %', total;
```

Варианты:

- NOTICE
- WARNING
- EXCEPTION

## 10. Отличие SQL-функции от PL/pgSQL-функции

|SQL            |	PL/pgSQL            |
|---------------|-----------------------|
|Один SELECT    |	Многошаговая логика |
|Нет переменных |	Есть переменные     |
|Нет циклов     |	Есть циклы          |
|Проще          |	Мощнее              |


## 11. Когда использовать PL/pgSQL

Использовать, если:

- требуется сложная логика
- есть ветвления
- есть несколько SQL-операций
- нужна проверка и обработка ошибок

Не использовать, если:

- можно решить одной SQL-командой
- логика принадлежит приложению

## 12. Производительность

PL/pgSQL:

- выполняется на сервере
- уменьшает сетевой трафик
- может ускорять пакетные операции

Но:

- чрезмерная логика усложняет поддержку
- не заменяет оптимизацию SQL

## 13. Типичные ошибки

|Ошибка                     |	Причина                     |
|---------------------------|-------------------------------|
|SELECT без INTO            |	Синтаксическая ошибка       |
|Отсутствие RETURN          |	Ошибка выполнения           |
|Неправильный тип переменной|	Несоответствие типов        |
|Избыточные циклы           |	Потеря производительности   |

## 14. Архитектурный аспект

PL/pgSQL:

- используется в триггерах
- применяется для контроля данных
- формирует слой бизнес-логики внутри БД
- требует аккуратного проектирования

## 15. Выводы

PL/pgSQL:

- расширяет SQL процедурной логикой
- позволяет писать сложные функции
- поддерживает переменные, условия, циклы
- используется в триггерах и бизнес-правилах
- является мощным инструментом серверной логики

## Домашнее задание

Таблицы:

- employees (id, full_name, salary, department)
- clients
- orders
- order_items

### Задание 1.

Создать функцию `get_department_total_salary(p_department TEXT)`

Которая:

- вычисляет сумму зарплат по отделу
- возвращает 0, если сотрудников нет

> Использовать: переменную `SELECT INTO` обработку `NULL`

### Задание 2. Условная логика

Создать функцию `get_employee_level(p_salary NUMERIC)`

Которая возвращает:

- 'Junior' — если зарплата < 50 000
- 'Middle' — если 50 000–100 000
- 'Senior' — если > 100 000

> Использовать IF / ELSIF / ELSE.

### Задание 3.

Создать функцию `increase_salary_for_department(p_department TEXT, p_percent NUMERIC)`

Которая:

- проходит по всем сотрудникам отдела
- увеличивает зарплату
- выводит через RAISE NOTICE имя сотрудника

> Использовать: `FOR record IN SELECT`, `UPDATE`, переменную-счётчик

### Задание 4.

Создать функцию: `safe_divide(a NUMERIC, b NUMERIC)`

Которая:

- выполняет деление
- если b = 0, перехватывает ошибку
- возвращает NULL (когда это необходимо)
- выводит сообщение через RAISE NOTICE

> Использовать блок EXCEPTION.

### Задание 5

Создать функцию `assign_client_status(p_client_id INT)`

Которая:

- Вычисляет сумму заказов клиента
- Определяет статус (VIP, Regular, New)
- Обновляет поле status в таблице clients
- Возвращает новый статус

Использовать:

- переменные
- SELECT INTO
- IF
- UPDATE
- RETURN

### Контрольные вопросы

1. Что такое PL/pgSQL и чем он отличается от обычного SQL?
2. Из каких блоков состоит функция на PL/pgSQL?
3. Зачем используется DECLARE?
4. Почему в PL/pgSQL нельзя писать просто SELECT без INTO?
5. Как работает цикл FOR record IN SELECT?
6. Что делает блок EXCEPTION?
7. В чём опасность избыточного использования циклов в БД?
8. Когда логика должна находиться в БД, а когда — в приложении?