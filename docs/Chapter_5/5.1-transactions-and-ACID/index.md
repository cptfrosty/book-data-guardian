# Транзакции и ACID

**Тип:** лекция

## 1. Что такое транзакция

**Транзакция** — это логически завершённая последовательность операций с БД, которая выполняется как единое целое.

Главный принцип: либо выполняются все операции, либо не выполняется ни одна.

## 2. Зачем нужны транзакции

Транзакции обеспечивают:

- целостность данных
- согласованность системы
- защиту от частичных изменений
- корректность при одновременной работе пользователей

## 3. Базовые команды управления транзакциями

### BEGIN
```sql
BEGIN;
```

Начало транзакции.

### COMMIT

```sql
COMMIT;
```

Фиксирует изменения.

### ROLLBACK
ROLLBACK;

Отменяет все изменения в рамках транзакции.

### SAVEPOINT

```sql
SAVEPOINT sp1;
```

Создаёт точку частичного отката.

```sql
ROLLBACK TO sp1;
```

## 4. Пример транзакции

Перевод денег между счетами:

```sql
BEGIN;

UPDATE accounts
SET balance = balance - 1000
WHERE id = 1;

UPDATE accounts
SET balance = balance + 1000
WHERE id = 2;

COMMIT;
```

Если вторая операция завершится ошибкой → выполняется ROLLBACK.

## 5. Свойства ACID

ACID — четыре ключевых свойства транзакций:

|Свойство       | Значение          |
|---------------|-------------------|
|Atomicity      | Атомарность       |
|Consistency    | Согласованность   |
|Isolation	    | Изолированность   |
|Durability	    | Надёжность        |


## 6. Atomicity (Атомарность)

Транзакция выполняется полностью или не выполняется вовсе.

> Если одна операция завершается ошибкой — вся транзакция отменяется.

## 7. Consistency (Согласованность)

После завершения транзакции БД остаётся в корректном состоянии.

Это обеспечивается:

- ограничениями
- триггерами
- внешними ключами
- бизнес-логикой

## 8. Isolation (Изолированность)

Транзакции не должны мешать друг другу.

Одновременная работа может приводить к:

- грязному чтению
- неповторяемому чтению
- фантомным строкам

## 9. Уровни изоляции

В PostgreSQL поддерживаются:

- Read Committed (по умолчанию)
- Repeatable Read
- Serializable

### Read Committed

Видны только зафиксированные данные

Возможны неповторяемые чтения

### Repeatable Read

- Повторное чтение даёт те же данные
- Нет неповторяемого чтения
- Возможны фантомы (ограниченно)

### Serializable

- Максимальная изоляция
- Поведение как при последовательном выполнении
- Возможны ошибки сериализации

## 10. Durability (Надёжность)

После COMMIT данные сохраняются даже при сбое системы.

Обеспечивается:

- журналированием (WAL)
- механизмом восстановления

## 11. Проблемы конкурентного доступа

**Грязное чтение** - чтение незафиксированных данных.

**Неповторяемое чтение** - повторный SELECT возвращает разные значения.

**Фантомные строки** - повторный SELECT возвращает новые строки.

## 12. Автоматические транзакции

```sql
UPDATE employees SET salary = 100000;
```

Если нет BEGIN, операция автоматически фиксируется.

## 13. Транзакции и триггеры

- Триггеры выполняются внутри транзакции
- Если триггер вызывает ошибку — вся транзакция откатывается

## 14. Транзакции и функции

Функции:

- выполняются в контексте текущей транзакции
- не могут самостоятельно выполнить COMMIT (в функциях)

> Процедуры (CALL) могут управлять транзакцией.

## 15. Типичные ошибки

|Ошибка                     | Причина                   |
|---------------------------|---------------------------|
|UPDATE без транзакции      | Потеря данных             |
|Непонимание уровня изоляции| Логические ошибки         |
|Ожидание dirty read        | PostgreSQL не допускает   |
|Игнорирование ROLLBACK     | Повреждение данных        |

## 16. Когда обязательно использовать транзакции

- финансовые операции
- пакетные обновления
- связанные изменения нескольких таблиц
- бизнес-процессы с несколькими шагами

## 17. Архитектурный аспект

Транзакции:

- основа целостности данных
- критичны для многопользовательских систем
- тесно связаны с производительностью

Неправильная настройка изоляции может:

- снижать производительность
- вызывать блокировки
- создавать взаимные блокировки (deadlocks)

## 18. Выводы

Транзакции:

- объединяют операции в единое целое
- обеспечивают свойства ACID
- управляются через BEGIN / COMMIT / ROLLBACK
- защищают данные при конкурентной работе
- являются фундаментом надёжности БД

## Домашнее задание

Таблица предметной области

```sql
accounts (id SERIAL PRIMARY KEY, owner TEXT, balance NUMERIC);
orders (id SERIAL PRIMARY KEY, client_id INT, total_amount NUMERIC);
employees (id SERIAL PRIMARY KEY, salary NUMERIC);
```

### Задание 1. Атомарность (Atomicity)

Реализовать перевод средств между счетами:

- Уменьшить баланс одного счёта
- Увеличить баланс другого
- Зафиксировать изменения

Реализовать:

- корректную транзакцию
- вариант с ошибкой
- вариант с ROLLBACK

> Объяснить, как обеспечивается атомарность.

### Задание 2. SAVEPOINT

1. Начать транзакцию
2. Изменить зарплаты нескольких сотрудников
3. Создать SAVEPOINT
4. Выполнить ошибочную операцию
5. Откатиться к SAVEPOINT

Зафиксировать результат.

> Объяснить разницу между ROLLBACK и ROLLBACK TO.

### Задание 3. Consistency

Создать транзакцию, которая:

- добавляет заказ
- обновляет суммарный баланс клиента
- проверяет, что сумма не отрицательная

Объяснить, какие механизмы обеспечивают согласованность:

- ограничения
- триггеры
- транзакция

### Задание 4. Изоляция (анализ)

Смоделировать ситуацию в двух сессиях:

- Первая сессия обновляет баланс
- Вторая выполняет SELECT

Выполнить при уровне:

- READ COMMITTED
- REPEATABLE READ

> Описать различия в поведении.

### Задание 5

Создать сценарий, в котором:

- две транзакции одновременно изменяют один и тот же набор строк
- возникает блокировка

> Ответить:

> что такое deadlock

> как PostgreSQL его разрешает

## Контрольные вопросы

1. Что такое транзакция и зачем она нужна?
2. Расшифруйте ACID и объясните каждое свойство.
3. Чем отличается COMMIT от ROLLBACK?
4. Что такое SAVEPOINT и когда он используется?
5. Какие проблемы конкурентного доступа существуют?
6. Какие уровни изоляции поддерживает PostgreSQL?
7. Почему PostgreSQL не допускает Dirty Read?
8. Что такое deadlock и как он возникает?
9. Почему функции не могут выполнять COMMIT?
10. В каких случаях использование транзакций обязательно?