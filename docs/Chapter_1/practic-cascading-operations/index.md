# Каскадные операции

**Продолжительность:** 2 академических часа

**Цель:** научиться управлять поведением связанных таблиц при изменении и удалении данных с помощью каскадных операций и осознанно выбирать стратегию ссылочной целостности.

## Что такое каскадные операции

Каскадные операции — это правила, определяющие, что произойдёт с дочерними строками, если изменяется или удаляется родительская строка, на которую они ссылаются через FOREIGN KEY.

Они задаются в момент создания или изменения внешнего ключа:

```sql
FOREIGN KEY (child_col)
REFERENCES parent_table(id)
ON DELETE ...
ON UPDATE ...
```

## Типы каскадных действий
### RESTRICT / NO ACTION (по умолчанию)

Смысл: запретить удаление или изменение родительской строки, если есть зависимости.

```sql
ON DELETE RESTRICT
```

- Самый безопасный вариант
- Используется для критичных данных
- Предотвращает потерю информации

### CASCADE
Смысл: автоматически применяет операцию к зависимым строкам.

```sql
ON DELETE CASCADE
```

- Удаляет все связанные записи
- Может затронуть много таблиц
- Требует строгого понимания модели данных

Опасность: цепное удаление без возможности отката вне транзакции

### SET NULL

Смысл: разрывает связь, сохраняя данные.

```sql
ON DELETE SET NULL
```

- Подходит для необязательных связей
- Поле должно допускать NULL
- Часто используется для архивных данных

### SET DEFAULT
Смысл: устанавливает значение по умолчанию.

```sql
ON DELETE SET DEFAULT
```

- Используется редко
- Требует корректного DEFAULT
- Может усложнять логику

## ON DELETE vs ON UPDATE

| Операция  | Когда использовать            |
|-----------|-------------------------------|
| ON DELETE | Почти всегда                  |
| ON UPDATE | Только если PK может меняться |

В реальных системах первичные ключи почти никогда не обновляются, поэтому ON UPDATE CASCADE используется редко.

## Практический пример

Схема: факультет → кафедра → преподаватель
Родительская таблица

```sql
CREATE TABLE faculties (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);
```

Дочерняя таблица (кафедры)

```sql
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    faculty_id INT,
    CONSTRAINT fk_departments_faculty
        FOREIGN KEY (faculty_id)
        REFERENCES faculties(id)
        ON DELETE CASCADE
);
```

Зависимая таблица (преподаватели)

```sql
CREATE TABLE teachers (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL,
    department_id INT,
    CONSTRAINT fk_teachers_department
        FOREIGN KEY (department_id)
        REFERENCES departments(id)
        ON DELETE SET NULL
);
```

Эксперимент

```sql
DELETE FROM faculties WHERE id = 1;
```

Результат:
- кафедры удалены (CASCADE)
- у преподавателей department_id = NULL

## Индивидуальные задания
### Задание 1

Сравнение стратегий
Создайте 3 варианта связи между таблицами orders и order_items:

- RESTRICT
- CASCADE
- SET NULL

Для каждого варианта:

- выполните DELETE
- опишите последствия
- сделайте вывод, какой вариант подходит для финансовых данных

### Задание 2
Каскадное обновление

Создайте таблицы с нечисловым первичным ключом (например, code TEXT PRIMARY KEY).

Реализуйте:

- ON UPDATE CASCADE
- изменение значения ключа
- анализ влияния на дочерние таблицы

Ответьте: почему это плохая практика?

### Задание 3

Ошибка проектирования

Спроектируйте схему из 3 таблиц так, чтобы:

- одно DELETE удаляло более 10 строк в других таблицах
- операция выглядела безопасной на первый взгляд

Опишите, как избежать подобных ловушек.

### Задание 4
Перепроектирование

Дана связь с ON DELETE CASCADE.

Измените её на:

- RESTRICT
- затем на SET NULL

Используйте ALTER TABLE
Зафиксируйте изменения поведения системы

### Задание 5. Архитектурное решение

Дана предметная область:

> Увольнение сотрудника не должно удалять его отчёты и документы.

Предложите:

- структуру таблиц
- тип каскадных операций
- обоснование выбора