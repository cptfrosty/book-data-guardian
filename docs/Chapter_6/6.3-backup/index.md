# Резервное копирование в PostgreSQL

**Тип:** лекция

## 1. Зачем нужно резервное копирование

**Резервное копирование (Backup)** — это создание копии данных для их восстановления в случае:

- аппаратного сбоя
- ошибки администратора
- логической ошибки приложения
- повреждения данных
- атаки или удаления

> Бэкап — основа надёжности БД.

## 2. Основные цели резервного копирования

Администратор должен понимать два параметра:

- RPO (Recovery Point Objective) — допустимая потеря данных
- RTO (Recovery Time Objective) — допустимое время восстановления

## 3. Типы резервного копирования

В PostgreSQL используются:

- Логический бэкап
- Физический бэкап
- Непрерывное архивирование (WAL)

## 4. Логический бэкап (pg_dump)

Создаёт SQL-дамп или архив.

Команда:
```sql
pg_dump -U user -d database_name > backup.sql
```

Варианты формата:

|Формат     |Ключ               |	Назначение          |
|-----------|-------------------|-----------------------|
|Plain SQL  | (по умолчанию)    |	Текстовый файл      |
|Custom     |	-Fc             |	Для pg_restore      |
|Directory  |	-Fd             |	Многофайловый архив |
|Tar        |	-Ft             |	Архив tar           |

Пример:

```sql
pg_dump -U postgres -Fc mydb -f backup.dump
```

## 5. Восстановление логического бэкапа

Из SQL-файла:

```sql
psql -U postgres -d mydb < backup.sql
```
Из custom-формата:

```sql
pg_restore -U postgres -d mydb backup.dump
```

## 6. Особенности логического бэкапа

Плюсы:

- Переносим между версиями
- Можно восстановить отдельную таблицу
- Читаемый формат

Минусы: 

- Медленнее на больших БД
- Не подходит для больших нагрузок

## 7. Физический бэкап

Создаётся копированием файлов кластера PostgreSQL.

Используется инструмент:

```pg_basebackup```

Пример:

```sql
pg_basebackup -U postgres -D /backup_directory -Fp -Xs -P
```

Параметры:

-D — каталог назначения
-Fp — формат plain
-Xs — включить WAL
-P — прогресс

## 8. WAL (Write-Ahead Log)

PostgreSQL использует журналирование.

Все изменения записываются в WAL до записи в таблицу.

WAL обеспечивает:

- Durability (долговечность)
- восстановление после сбоя

## 9. Архивирование WAL

Для непрерывного резервирования:

```sql
archive_mode = on
archive_command = 'cp %p /archive/%f'
```

Позволяет выполнять Point-In-Time Recovery (PITR) — восстановление к конкретному моменту времени.

## 10. Стратегии резервного копирования

### 10.1 Полный бэкап

- копия всей БД
- обычно ежедневно

### 10.2 Инкрементальный бэкап

- копируются только изменения
- реализуется через WAL

### 10.3 Дифференциальный

- копируются изменения с момента последнего полного бэкапа

### 11. Горячий и холодный бэкап

|Тип        | Особенность   |
|-----------|---------------|
|Cold Backup| БД остановлена|
|Hot Backup | БД работает   |

> PostgreSQL поддерживает горячее резервирование.

## 12. Проверка бэкапа

Бэкап без проверки — бесполезен.

Рекомендуется:

- регулярно тестировать восстановление
- хранить копии на другом сервере
- использовать контрольные суммы

## 13. Ротация резервных копий

Используются схемы:

- 7 ежедневных
- 4 недельных
- 12 месячных

> Это называется стратегия GFS (Grandfather-Father-Son).

## 14. Типичные ошибки

|Ошибка                         |	Причина                     |
|-------------------------------|-------------------------------|
|Нет регулярного бэкапа         |	Отсутствие политики         |
|Хранение на том же сервере     |	Риск потери                 |
|Нет тестирования восстановления|	Ложное чувство безопасности |
|Нет архивирования WAL          |	Потеря данных между бэкапами|

## 15. Когда использовать каждый тип

|Сценарий           |	Рекомендуемый метод |
|-------------------|-----------------------|
|Маленькая БД       |	pg_dump             |
|Большая БД         |	pg_basebackup       |
|Критическая система|	Base backup + WAL   |
|Миграция           |	Логический дамп     |

## 16. Архитектурный вывод

Резервное копирование — это не разовая операция а стратегия связанная с RPO и RTO требующая регулярного тестирования

## 17. Выводы

Резервное копирование в PostgreSQL:

- реализуется через pg_dump и pg_basebackup
- поддерживает PITR через WAL
- требует продуманной политики хранения
- является критически важным элементом администрирования

## Домашнее задание

### Задание 1. Логический бэкап (pg_dump)

Создать логический бэкап всей базы данных в формате SQL.

Создать бэкап в формате custom (-Fc).

Сравнить размер файлов.

Описать различия форматов.

> В отчёте указать использованные команды.

### Задание 2. Восстановление

Создать новую пустую базу `company_restore`.

Восстановить данные:

- из SQL-файла
- из custom-формата через pg_restore.

Проверить корректность восстановления (количество таблиц, строк).

> Объяснить разницу между psql < file.sql и pg_restore.

### Задание 3. Частичное восстановление

Создать бэкап только одной таблицы `employees`.

Восстановить её в новую БД.

Проверить результат.

> Объяснить, в каком случае это удобно.

### Задание 4. Анализ стратегии

Смоделировать ситуацию:

- БД размером 200 ГБ
- 24/7 нагрузка
- допустимая потеря данных — 5 минут

Ответить:

- какой тип бэкапа использовать?
- нужно ли архивирование WAL?
- как часто выполнять полный бэкап?

### Задание 5

Составить стратегию резервного копирования для:

- интернет-магазина
- бухгалтерской системы
- тестового учебного проекта

Указать:

- тип бэкапа
- периодичность
- RPO
- RTO

## Контрольные вопросы

1. В чём разница между логическим и физическим бэкапом?
2. Что такое WAL и какую роль он играет?
3. Что такое Point-In-Time Recovery (PITR)?
4. Чем отличается pg_dump от pg_basebackup?
5. Что такое горячий и холодный бэкап?
6. Что означают RPO и RTO?
7. Почему хранить бэкап на том же сервере — плохая практика?
8. Почему необходимо регулярно тестировать восстановление?
9. Можно ли восстановить одну таблицу из физического бэкапа?
10. В каком случае предпочтителен логический бэкап?