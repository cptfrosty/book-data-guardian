# Практическое занятие 3
**Название:** ограничения целостности данных

**Продолжительность:** 2 академических часа (90 мин)

**Цель:** сформировать практические навыки задания и использования ограничений целостности данных при проектировании таблиц базы данных.


Целостность данных — это набор правил, обеспечивающих корректность, непротиворечивость и достоверность информации в базе данных.

Основные виды ограничений

## PRIMARY KEY

Обеспечивает уникальность строки

Не допускает NULL

В таблице может быть только один

```sql
id SERIAL PRIMARY KEY
```

## UNIQUE

Запрещает дублирование значений

Допускает NULL (в PostgreSQL — несколько NULL)

```sql
email TEXT UNIQUE
```

## NOT NULL

Запрещает хранение NULL

```sql
name TEXT NOT NULL
```

## CHECK

Проверяет логическое условие

```sql
age INT CHECK (age >= 18)
```

## FOREIGN KEY

Обеспечивает ссылочную целостность

Связывает таблицы между собой

```sql
FOREIGN KEY (department_id)
REFERENCES departments(id)
```

Каскадные операции

| Опция                 | Назначение                |
|-----------------------|---------------------------|
| ON DELETE CASCADE     | Удаляет зависимые строки  |
| ON DELETE RESTRICT    | Запрещает удаление        |
| ON DELETE SET NULL    | Обнуляет ссылку           |

## Практический пример

Создание родительской таблицы
```SQL
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);
```

Создание дочерней таблицы с ограничениями
```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL,
    email TEXT UNIQUE,
    age INT CHECK (age >= 18),
    department_id INT,
    CONSTRAINT fk_department
        FOREIGN KEY (department_id)
        REFERENCES departments(id)
        ON DELETE SET NULL
);
```

Проверка работы ограничений
```sql
INSERT INTO employees (full_name, age)
VALUES ('Иванов Иван', 16);
```

Результат: ошибка CHECK constraint failed

## Индивидуальные задания
### Задание 1
*Комплексные ограничения в одной таблице*

Спроектируйте таблицу employees со следующими требованиями:

- id — первичный ключ
- email (обязателен, уникален, должен содержать символ @)
- salary (больше 0, меньше 500 000)
- hire_date (не может быть больше текущей даты)

Требуется:

- использовать минимум 3 разных типа ограничений
- дать имена всем ограничениям
- показать 2 примера ошибочных INSERT и объяснить ошибки

### Задание 2
*Составной PRIMARY KEY + бизнес-логика*

Создайте таблицу enrollments, отражающую запись студентов на курсы:

|Поле|Требование|
|-----------|-----------------------------------------------|
|student_id |   ссылка на students(id)                      |
|course_id  |	ссылка на courses(id)                       |
|enroll_date|	обязательное                                |
|status	    |   только: 'active', 'completed', 'canceled'   |

Условия:

- один студент не может быть записан на один курс дважды
- используйте составной первичный ключ
- примените CHECK для статуса

Объясните, почему здесь лучше PRIMARY KEY, а не UNIQUE.

### Задание 3
*Цепочка ссылочной целостности*

Создайте три таблицы:
- faculties
- departments
- teachers

Связи:
факультет → кафедры → преподаватели

При удалении факультета:

- кафедры удаляются
- преподаватели остаются, но их department_id становится NULL

Все внешние ключи должны быть именованными.

Проверьте цепочку удалений и зафиксируйте результат.

### Задание 4
*Ограничения + изменение структуры*

Создайте таблицу contracts без ограничений.

Затем через ALTER TABLE:

- добавьте PRIMARY KEY
- добавьте CHECK на срок договора (end_date > start_date)
- добавьте UNIQUE на номер договора
- добавьте FOREIGN KEY на таблицу clients

Объясните:

- почему СУБД может отказать в добавлении ограничения
- в каком порядке безопаснее добавлять ограничения

### Задание 5
*Диагностика и исправление ошибок*

```sql
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    user_id INT,
    amount NUMERIC,
    payment_date DATE,
    status TEXT
);
```

Требуется:

Добавить ограничения:

- amount > 0
- status только 'new', 'paid', 'failed'
- user_id — внешний ключ

Намеренно вставить данные, нарушающие ограничения.

Зафиксировать сообщения об ошибках.

Исправить структуру таблицы так, чтобы ошибки больше не возникали.