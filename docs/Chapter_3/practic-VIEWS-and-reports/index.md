## Практическое занятие 8. VIEW и отчёты

**Цель:** научить студентов создавать представления для аналитики; строить отчётные VIEW поверх агрегированных данных; использовать VIEW как логический слой; различать VIEW и MATERIALIZED VIEW; проектировать структуру отчёта на уровне БД

## Исходная предметная область

Модель продаж

```sql
clients (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    city TEXT
);

orders (
    id SERIAL PRIMARY KEY,
    client_id INT REFERENCES clients(id),
    order_date DATE
);

order_items (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id),
    product_name TEXT,
    quantity INT,
    price NUMERIC
);
```

## Задание 1

Создать представление client_sales_report, которое содержит:

- id клиента
- ФИО
- город
- количество заказов
- общую сумму продаж
- средний чек

Требования:

- минимум 2 JOIN
- GROUP BY
- агрегатные функции
- корректные псевдонимы столбцов

## Задание 2

Используя client_sales_report, вывести:

- клиентов с суммой продаж более 100 000
- отсортировать по убыванию суммы

> Запрещено повторять исходный агрегатный запрос.

## Задание 3

Создать представление monthly_sales_report, содержащее:

- месяц
- количество заказов
- общую выручку
- средний чек

Использовать:

```sql
DATE_TRUNC('month', order_date)
```

## Задание 4

На основе monthly_sales_report вывести месяц с максимальной выручкой

> Использовать подзапрос или CTE.

## Задание 5

Создать представление city_sales_report, которое содержит:

- город
- количество клиентов
- общую выручку
- среднюю выручку на клиента

## Задание 6

Дополнить отчёт добавить долю города в общей выручке (%)

> Разрешено использовать CTE внутри VIEW.

## Задание 7

Создать MATERIALIZED VIEW product_sales_summary, которое содержит:

- товар
- общее количество продаж
- общую выручку

## Задание 8

Добавить новые данные в таблицы.

Проверить, изменился ли отчёт.

Выполнить:

```sql
REFRESH MATERIALIZED VIEW product_sales_summary;
```

> Объяснить разницу в поведении.

## Задание 9

Спроектировать структуру отчётного слоя БД:

- один VIEW — детализированный отчёт
- один VIEW — агрегированный отчёт
- один MATERIALIZED VIEW — итоговая аналитика

Объяснить:

- зачем разделять уровни
- какие запросы должны использовать BI-инструменты

## Индивидуальные задания (оценка)

**Вариант 1.** Создать отчёт по товарам с сортировкой по прибыли.

**Вариант 2.** Создать отчёт по клиентам без заказов.

**Вариант 3.** Создать отчёт по городам за последний год.

**Вариант 4.** Создать VIEW с ранжированием клиентов по сумме (без оконных функций).

**Вариант 5.** Создать отчёт «Топ-5 клиентов».