# Агрегатные функции в SQL

**Тип занятия:** лекция

**Продолжительность:** 2 академических часа

## 1. Что такое агрегатные функции

Агрегатная функция — это функция, которая:

- принимает набор строк

- возвращает одно итоговое значение

В отличие от обычных функций, агрегат работает над группой данных, а не над одной строкой.

## 2. Основные агрегатные функции

|Функция| Назначение            |
|-------|-----------------------|
|COUNT()| Подсчёт строк         |
|SUM()  |	Сумма               |
|AVG()  |	Среднее значение    |
|MIN()  |	Минимум             |
|MAX()  |	Максимум            |

## 3. Исходная таблица для примеров

```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    salary NUMERIC,
    department_id INT
);
```

## 4. COUNT()

### COUNT(*)

```sql
SELECT COUNT(*)
FROM employees;
```

Считает все строки.

### COUNT(column)

```sql
SELECT COUNT(department_id)
FROM employees;
```

Не учитывает NULL.

### COUNT(DISTINCT)

```sql
SELECT COUNT(DISTINCT department_id)
FROM employees;
```

Считает уникальные значения.

## 5. SUM()

```sql
SELECT SUM(salary)
FROM employees;
```

Возвращает сумму всех зарплат.

>NULL игнорируется.

## 6. AVG()

```sql
SELECT AVG(salary)
FROM employees; 
```

Среднее значение.

> В PostgreSQL возвращает тип numeric.

## 7. MIN() и MAX()

```sql
SELECT MIN(salary), MAX(salary)
FROM employees;
```

Работают с:

- числами
- датами
- строками (лексикографически)

## 8. GROUP BY — группировка

Агрегатные функции почти всегда используются с `GROUP BY`.

```sql
SELECT department_id, COUNT(*)
FROM employees
GROUP BY department_id;
```

Группировка выполняется до вычисления агрегатов.

## 9. Логика выполнения запроса

SQL выполняется логически в порядке:

- FROM
- JOIN
- WHERE
- GROUP BY
- HAVING
- SELECT
- ORDER BY

Понимание этого критично для агрегатов.

## 10. HAVING — фильтрация групп

`WHERE` работает до группировки.
`HAVING` — после.

```sql
SELECT department_id, COUNT(*)
FROM employees
GROUP BY department_id
HAVING COUNT(*) > 3;
```

Отбираем только группы с более чем 3 сотрудниками.

## 11. Типичные ошибки

|Ошибка                             | Причина                       |
|-----------------------------------|-------------------------------|
|Использование столбца без GROUP BY | Нарушение логики группировки  |
|COUNT(column) вместо COUNT(*)      | Неправильный подсчёт          |
|WHERE вместо HAVING                | Фильтрация до группировки     |
|Непонимание NULL                   | Искажение результата          |

## 12. Комплексный пример

```sql
SELECT 
    department_id,
    COUNT(*) AS total_employees,
    AVG(salary) AS avg_salary,
    MAX(salary) AS max_salary
FROM employees
GROUP BY department_id
HAVING AVG(salary) > 50000
ORDER BY avg_salary DESC;
```

Здесь используются:

- группировка
- несколько агрегатов
- фильтрация по агрегату
- сортировка

## 13. Агрегаты и JOIN

```sql
SELECT d.name, COUNT(e.id)
FROM departments d
LEFT JOIN employees e
    ON e.department_id = d.id
GROUP BY d.name;
```

Позволяет получить количество сотрудников по отделам.

## 14. NULL и агрегаты

|Функция	    | Учитывает NULL|
|---------------|---------------|
|COUNT(*)	    | Да            |
|COUNT(column)  | Нет           |
|SUM	        | Нет           |
|AVG	        | Нет           |
|MIN / MAX      | Нет           |


## 15. Выводы

- Агрегаты работают над группами строк
- Почти всегда используются с `GROUP BY`
- `HAVING` фильтрует агрегированные данные
- Ошибки чаще логические, а не синтаксические

## Домашнее задание №1

Создайте таблицу `sales`:

```sql
id SERIAL PRIMARY KEY,
product_name TEXT,
category TEXT,
price NUMERIC,
quantity INT,
sale_date DATE
```

Напишите запросы:

- Общее количество продаж.
- Общая сумма продаж (price * quantity).
- Средняя цена товара.
- Минимальная и максимальная цена.
- Количество уникальных категорий.

## Домашнее задание №2

Используя таблицу `sales`, напишите запросы:

- Сумма продаж по категориям.
- Количество продаж по датам.
- Категории, где общая сумма продаж больше 100 000.
- Даты, когда было продано более 10 единиц товара.
- Категорию с максимальной выручкой.

Обязательное условие использовать HAVING минимум в двух запросах.

## Домашнее задание №3

Создайте таблицы:

- clients
- orders
- order_items

Связи:
- заказ принадлежит клиенту
- заказ содержит несколько позиций

Напишите запросы:

- Общая сумма заказов по каждому клиенту.
- Клиенты, у которых сумма заказов больше средней.
- Количество заказов у каждого клиента.
- Клиенты без заказов.
- Топ-3 клиента по сумме покупок.

Требования:

- использовать JOIN
- использовать минимум 2 агрегатные функции в одном запросе
- объяснить разницу между COUNT(*) и COUNT(column)

## Контрольные вопросы

1. Что такое агрегатная функция и чем она отличается от обычной функции?
2. В чём разница между `COUNT(*)` и `COUNT(column)`?
3. Почему нельзя использовать столбец в `SELECT`, если он не входит в `GROUP BY` и не является агрегатом?
4. Чем отличается `WHERE` от `HAVING`?
5. Как агрегатные функции работают с `NULL`?
6. Почему при использовании `LEFT JOIN` и `COUNT()` можно получить неожиданный результат?
7. Можно ли использовать несколько агрегатных функций в одном запросе?