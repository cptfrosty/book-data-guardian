# Уровни изоляции транзакций

## 1. Зачем нужны уровни изоляции

В многопользовательской системе несколько транзакций могут выполняться одновременно.

Если не управлять их взаимодействием, возникают проблемы:

- чтение незафиксированных данных
- изменение данных между чтениями
- появление «фантомных» строк

> Уровень изоляции определяет, насколько транзакции видят изменения друг друга.

## 2. Проблемы конкурентного доступа
###  Грязное чтение

Транзакция читает данные, которые другая транзакция ещё не зафиксировала.

> В PostgreSQL невозможно (не поддерживается).

### 2.2 Неповторяемое чтение

Одна и та же строка читается дважды, но между чтениями была изменена другой транзакцией.

### 2.3 Фантомное чтение

Повторный SELECT возвращает новые строки, которых раньше не было.

## 3. Стандартные уровни изоляции (SQL Standard)

|Уровень	        |Грязное чтение |	Неповторяемое чтение|	Фантомное чтение|
|-------------------|---------------|-----------------------|-------------------|
|Read Uncommitted   |	Возможен    |	Возможен            |	Возможен        |
|Read Committed     |	Нет         |	Возможен            |	Возможен        |
|Repeatable Read    |	Нет         |	Нет                 |	Возможен        |
|Serializable       |	Нет         |	Нет                 |	Нет             |

## 4. Уровни изоляции в PostgreSQL

PostgreSQL поддерживает:

- Read Committed (по умолчанию)
- Repeatable Read
- Serializable

> Read Uncommitted фактически работает как Read Committed.

## 5. Read Committed

Устанавливается по умолчанию.

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

### Поведение:

- Каждое `SELECT` видит только зафиксированные данные
- Между двумя `SELECT` внутри одной транзакции данные могут измениться

> Возможны:

- неповторяемые чтения
- фантомы

### Пример

Транзакция A:

```sql
BEGIN;
SELECT balance FROM accounts WHERE id = 1;
```


Транзакция B:

```sql
UPDATE accounts SET balance = 5000 WHERE id = 1;
COMMIT;
```


Транзакция A повторяет SELECT → увидит новое значение.

## 6. Repeatable Read

```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```

### Поведение:

- Все `SELECT` внутри транзакции видят снимок данных на момент `BEGIN`
- Повторное чтение даёт тот же результат

> Non-repeatable read невозможен.

> Phantom read в PostgreSQL также предотвращается благодаря MVCC.

### Snapshot Isolation

PostgreSQL использует механизм MVCC (Multi-Version Concurrency Control).

> Каждая транзакция видит свою «версию» данных.

## 7. Serializable

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

Поведение:

- Транзакции работают так, как будто выполняются последовательно
- Если возникает конфликт — одна из транзакций завершится ошибкой

Ошибка:

```sql
ERROR: could not serialize access due to concurrent update
```

> Требуется повторить транзакцию.

## 8. MVCC — механизм PostgreSQL

PostgreSQL не блокирует чтение при записи.

Каждая строка имеет:

- xmin — кто создал
- xmax — кто удалил

> Транзакции видят только «свои» допустимые версии строк.

## 9. Блокировки и изоляция

Уровень изоляции влияет на:

- частоту блокировок
- вероятность конфликтов
- производительность

Чем выше изоляция → тем:

- выше безопасность
- ниже производительность

## 10. Сравнение уровней
|Уровень            |	Безопасность    | Производительность| Риск ошибок           |
|-------------------|-------------------|-------------------|-----------------------|
|Read Committed     |	Средняя         |	Высокая         | Логические            |
|Repeatable Read    |	Высокая         |	Средняя	        | Конфликты             |
|Serializable       |	Максимальная    |	Ниже            | Ошибки сериализации   |

## 11. Когда использовать каждый уровень

Read Committed:

- стандартные CRUD-операции
- отчётность
- не критичные расчёты

Repeatable Read:

- аналитика
- расчёт балансов
- операции, требующие стабильного набора данных

Serializable:

- финансовые системы
- критические бизнес-процессы
- расчёты с жёсткой согласованностью

## 12. Типичные ошибки

|Ошибка                             |	Причина                         |
|-----------------------------------|-----------------------------------|
|Ожидание Dirty Read                |	PostgreSQL его не поддерживает  |
|Непонимание snapshot               |	Логические ошибки               |
|Игнорирование сериализации         |	Ошибки выполнения               |
|Повышение уровня без необходимости |	Падение производительности      |

## 13. Архитектурный вывод

Уровень изоляции — это компромисс между:

- безопасностью
- согласованностью
- производительностью

> Правильный выбор зависит от типа системы.

## 14. Выводы

Уровни изоляции:

- регулируют взаимодействие транзакций
- предотвращают проблемы конкурентного доступа
- основаны на механизме MVCC
- требуют осознанного выбора

## Домашнее задание

Предметная область:

```sql
accounts (
    id SERIAL PRIMARY KEY,
    owner TEXT,
    balance NUMERIC
);
```

> Предварительно добавьте тестовые данные.

### Задание 1. Read Committed

Открыть две сессии (A и B).

Сессия A:
```sql
BEGIN;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT balance FROM accounts WHERE id = 1;
```

Сессия B:
```sql
UPDATE accounts SET balance = 9999 WHERE id = 1;
COMMIT;
```

Сессия A:

- Повторить SELECT.

> Ответить: изменилось ли значение и почему?

### Задание 2. Repeatable Read

Повторить эксперимент, но с уровнем:

```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```

> Ответить: изменилось ли значение? почему поведение отличается?

### Задание 3. Serializable

Создать две транзакции, которые одновременно уменьшают баланс одного счёта затем фиксируются

Использовать уровень:

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```


> Ответить: возникает ли ошибка? какая именно? почему?

### Задание 4. Анализ фантомного чтения

Создать таблицу:

```sql
orders (id SERIAL, total NUMERIC);
```

В двух сессиях:

- одна транзакция считает количество заказов > 1000
- другая добавляет новый заказ

Проверить поведение при:

- Read Committed
- Repeatable Read

> Объяснить результат.

### Задание 5

Смоделировать конфликт:

- две транзакции обновляют одну и ту же строку

- не фиксируются сразу

> Ответить: что происходит? что такое блокировка? что такое deadlock?


## Контрольные вопросы

1. Что регулирует уровень изоляции транзакции?
2. Какие уровни изоляции поддерживает PostgreSQL?
3. Что такое Dirty Read и почему в PostgreSQL он невозможен?
4. В чём разница между Read Committed и Repeatable Read?
5. Как работает механизм MVCC?
6. Почему Serializable может завершиться ошибкой?
7. Что такое snapshot данных?
8. Как уровень изоляции влияет на производительность?
9. В каком случае следует использовать Serializable?
10. Почему чрезмерно высокий уровень изоляции может быть вреден?

