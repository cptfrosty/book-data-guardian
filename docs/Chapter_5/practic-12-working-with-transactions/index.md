# Практическое занятие 12. Работа с транзакциями

**Цель:** сформировать навыки: управления транзакциями вручную; обеспечения атомарности операций; использования SAVEPOINT; моделирования конкурентных сценариев; анализа блокировок

## Исходная модель данных

```sql
accounts (
    id SERIAL PRIMARY KEY,
    owner TEXT,
    balance NUMERIC
);

employees (
    id SERIAL PRIMARY KEY,
    full_name TEXT,
    salary NUMERIC
);
```

Предварительно заполнить тестовыми данными.

## Задание 1. COMMIT

1. Начать транзакцию:

```sql
BEGIN;
```

2. Изменить баланс одного счёта.

3. Проверить изменение в той же сессии.

4. Выполнить:

```sql
COMMIT;
```

> Проверить, сохранились ли изменения.

## Задание 2. ROLLBACK

1. Начать транзакцию.

2. Выполнить `UPDATE`.

3. Проверить изменение.

4. Выполнить:

```sql
ROLLBACK;
```

> Убедиться, что данные вернулись к исходному состоянию.


## Задание 3. Перевод средств

Реализовать перевод между счетами:

```sql
BEGIN;

UPDATE accounts
SET balance = balance - 1000
WHERE id = 1;

UPDATE accounts
SET balance = balance + 1000
WHERE id = 2;

COMMIT;
```

Смоделировать ошибку во второй операции.

Использовать ROLLBACK.

> Ответить: как обеспечивается Atomicity.

## Задание 4

1. Начать транзакцию.

2. Изменить зарплаты нескольких сотрудников.

3. Создать:

```sql
SAVEPOINT sp1;
```

4. Выполнить ошибочную операцию.

Выполнить:

```sql
ROLLBACK TO sp1;
```

5. Зафиксировать изменения через COMMIT.

> Объяснить разницу между ROLLBACK и ROLLBACK TO


Задание 5. Блокировка строки

> Требуется открыть две сессии psql.

Сессия A:
```sql
BEGIN;
UPDATE accounts
SET balance = balance + 500
WHERE id = 1;
```

(не выполнять COMMIT)

Сессия B:

```sql
UPDATE accounts
SET balance = balance - 200
WHERE id = 1;
```

> Что происходит? Почему запрос «зависает»?

После этого выполнить `COMMIT` в первой сессии.

## Задание 6. Анализ блокировок

Во время блокировки выполнить:

```sql
SELECT * FROM pg_locks;
```

Определить:

- тип блокировки
- объект блокировки

## Задание 7

В двух сессиях:

- выполнить SELECT
- затем UPDATE в другой сессии
- повторить SELECT

Проверить поведение при:

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```

> Объяснить различия.

## Задание 8

Установить:

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

В двух сессиях одновременно изменить одну и ту же строку.

> Зафиксировать ошибку сериализации.

> Объяснить причину.

## Индивидуальные задания

**Вариант 1.** Реализовать транзакцию начисления премии сотрудникам.

**Вариант 2.** Смоделировать откат части операции через SAVEPOINT.

**Вариант 3.** Создать конфликт обновления и объяснить поведение.

**Вариант 4.** Показать работу SERIALIZABLE с ошибкой.

**Вариант 5.** Объяснить механизм MVCC на примере.