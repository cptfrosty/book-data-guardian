# Практическое занятие 10. Триггеры контроля данных

**Цель:** научить студентов использовать триггеры для контроля данных; отличать триггер от ограничения (CHECK, FOREIGN KEY); применять NEW и OLD; выбрасывать исключения (RAISE EXCEPTION); понимать порядок выполнения операций

## Исходная модель данных

```sql
employees (
    id SERIAL PRIMARY KEY,
    full_name TEXT NOT NULL,
    salary NUMERIC,
    department TEXT,
    hire_date DATE
);

orders (
    id SERIAL PRIMARY KEY,
    client_id INT,
    order_date DATE,
    total_amount NUMERIC
);
```

## Задание 1

Создать триггер запрещающий устанавливать зарплату меньше 30 000, при нарушении — RAISE EXCEPTION

> Использовать BEFORE INSERT OR UPDATE.

## Задание 2

Создать триггер запрещающий устанавливать дату приёма на работу больше текущей даты

> Проверить поведение при INSERT.

## Задание 3

Создать триггер запрещающий уменьшать зарплату сотрудника.

Использовать `IF NEW.salary < OLD.salary THEN`

## Задание 4

Создать триггер запрещающий менять отдел сотрудника после 6 месяцев работы

> Подсказка:

> сравнить `hire_date` с текущей датой

> использовать `AGE()` или вычисление интервала

## Задание 5

Создать триггер для таблицы `orders` запрещающий создание заказа с отрицательной суммой и запрещающий создание заказа с датой в будущем

## Задание 6

Создать триггер запрещающий клиенту создавать более 10 заказов в день

Использовать: `SELECT COUNT(*)` и проверку внутри триггерной функции

## Задание 7

Модифицировать триггер изменения зарплаты чтобы он срабатывал только если зарплата реально изменилась

Использовать `WHEN (OLD.salary IS DISTINCT FROM NEW.salary)`

## Индивидуальные задания

**Вариант 1:** Запретить изменение hire_date после установки.

**Вариант 2:** Запретить удаление сотрудника с зарплатой выше 200 000.

**Вариант 3:** Ограничить максимальную зарплату по отделу.

**Вариант 4:** Запретить создание заказа без клиента.

**Вариант 5:** Ограничить сумму заказа максимум 1 000 000.